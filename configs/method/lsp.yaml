# @package _global_
# LSP configuration with support for both standard and ROI modes
#
# Standard LSP (classwise): For general classification/ReID tasks
# ROI-based LSP (samplewise + roi_mode=binary): For Medical Image Segmentation
#   - Generates TWO linearly separable noise patterns per sample
#   - Blends background and foreground noise based on segmentation mask
#   - "To adapt LSP and AR for MIS tasks, we treat pixels inside and outside the ROI as two distinct classes"

training:
  data:
    transforms:
      forbid_geom_aug: true
      normalize: false # poisoned dataset needs False on train
      pixel_aug: false
    poison:
      enabled: true
      perturb_type: samplewise
      apply_stage: before_normalize
      key: { type: samplewise, from: field, field: case_id }
      source:
        type: shards
        manifest_path: ${experiment.save_dir}/ue/lsp/manifest.json
      source:
        type: provider
        provider:
          name: lsp
          params:
            epsilon: 0.0313725
            seed: 0
            noise_frame_size: 32
            roi_mode: binary
            num_labels: 4

ue:
  store_dir: ${task.save_dir}/${task.run_name}/${now:%Y%m%d_%H%M%S}/ue/lsp
  algorithm:
    kind: training_free
    name: lsp
    params:
      epsilon: 0.0313725
      seed: 0
      noise_frame_size: 32
      class_sep: 10.0
      roi_mode: binary  # Enable ROI-based noise generation
      num_labels: 4     # Number of segmentation classes (BraTS: 0=bg, 1-3=tumor)
  key:
    type: samplewise
    from: field
    field: case_id
  io:
    enabled: true
    include_manifest: true
    strategy: files
    dtype: int8